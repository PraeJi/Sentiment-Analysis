from flask import Flask, request, jsonify, Response
import requests
import re
import json

app = Flask(__name__)

# การตั้งค่าการเชื่อมต่อ API LLM
MAI_LLM_url = "https://ai-api.manageai.co.th/llm-vl-model-01/v1/chat/completions"
headers = {"Content-Type": "application/json",
            "Authorization": "Basic bWFuYWdlYWkyMDI0Ok1hbmFnZUFJQDIwMjQ=",
            "Cookie": "Path=/"}

# ฟังก์ชันสำหรับส่งข้อความไปยัง LLM API เพื่อทำ Sentiment Analysis
def analyze_sentiment_llm(text_to_analyze):
    messages = [
        {"role": "system",
         "content": """
            คุณคือผู้เชี่ยวชาญด้านการวิเคราะห์ข้อความ โปรดวิเคราะห์ข้อความที่ได้รับ (เช่น รีวิวจากลูกค้า หรือความคิดเห็นเกี่ยวกับสินค้า/บริการ) และระบุ Topic, Intent และ Sentiment อย่างชัดเจน
            ###งานที่ต้องทำ###
            คุณต้องวิเคราะห์ข้อความที่ได้รับอย่างละเอียด และตอบกลับผลลัพธ์ในรูปแบบ JSON ที่มี 3 ส่วน ดังนี้:
            
            - **Topic**: ระบุหัวข้อหลักที่เฉพาะเจาะจง เป็นกลาง (ไม่มีอารมณ์หรือความรู้สึกแฝง) โดยเน้นที่สิ่งที่จับต้องได้ 
                         เช่น คุณภาพของสินค้า, การบริการลูกค้า, การจัดส่งสินค้า, การโฆษณาสินค้า,ราคาและโปรโมชั่น, การบริการหลังการขาย, การคืนสินค้า/เคลมสินค้า เป็นต้น
                         - หากข้อความมีหลายประเด็น ให้รวมหลาย Topic ที่เกี่ยวข้อง เช่น:
                           - “คุณภาพของสินค้าและการบริการลูกค้า”
                           - “การจัดส่งสินค้าและการบริการหลังการขาย”
                         -หลีกเลี่ยงคำทั่วไปหรือคลุมเครือ เช่น ความมั่นใจ, ความเชื่อมั่น, ความรู้สึก, ความพึงพอใจ,ความบกพร่องของสินค้า เป็นต้น
            - **Intent**: ระบุเจตนาหลักของข้อความให้ชัดเจนและสะท้อนสิ่งที่ผู้เขียนต้องการให้เกิดขึ้นจริง ๆ ไม่ใช่เพียงแค่ระบายหรือบ่น แต่ให้มองลึกถึง “เป้าหมาย” ของการเขียน เช่น ต้องการให้มีการแก้ไขปัญหา ชดเชย รับผิดชอบ หรืออธิบายเพิ่มเติม
                        - ควรเขียน Intent อย่างชัดเจน เช่น:  
                          - “ร้องเรียนเกี่ยวกับการจัดส่งล่าช้าและต้องการให้บริษัทรับผิดชอบหรือชดเชย”  
                          - “แสดงความไม่พอใจเกี่ยวกับคุณภาพของสินค้า และขอให้มีการปรับปรุงหรือเปลี่ยนสินค้า”
                        - หลีกเลี่ยงคำกว้าง ๆ เช่น “ไม่พอใจ”,“รู้สึกผิดหวัง”,“ไม่มั่นใจในสินค้า” หรือ “ไม่เชื่อถือในร้านค้า” ซึ่งไม่สะท้อนเป้าหมายของการเขียน
                        - หากในข้อความมีการเรียกร้องให้ดำเนินการบางอย่าง เช่น สินค้าเสียหาย(แตก,หัก), เปลี่ยนสินค้า, คืนเงิน, ชดเชย, ติดต่อกลับ ฯลฯ ต้องสะท้อนสิ่งนั้นใน Intent ด้วย
                        - ถ้ามีหลายเจตนา ให้ระบุทั้งหมดแบบกระชับ เช่น: “ร้องเรียนเรื่องสินค้าไม่ได้คุณภาพ, การจัดส่งล่าช้า และต้องการให้ชดเชยความเสียหาย”  
            - **Sentiment**: ระบุความรู้สึกโดยรวมของข้อความในภาพรวม ได้แก่ Positive, Negative, Neutral

            ###รูปแบบผลลัพธ์ที่ต้องการ:###
            โปรดตอบกลับผลลัพธ์ในรูปแบบ JSON เฉพาะรูปแบบด้านล่างนี้เท่านั้น:
            {
              "Topic": "หัวข้อหลัก",
              "Intent": "เจตนาหลักของข้อความ",
              "Sentiment": "Positive | Neutral | Negative"
            }
            
            **ข้อสำคัญ:**  
            - ผลลัพธ์ทุกส่วนต้องใช้ภาษาไทยที่ถูกต้องตามหลักไวยากรณ์  
            - ห้ามสะกดผิดทุกกรณี  
            - หากข้อความต้นฉบับมีคำผิด ให้แปลความหมายและสะกดให้ถูกต้องในผลลัพธ์
            
            ###ตัวอย่างข้อความและผลลัพธ์:###
            **ตัวอย่างที่ 1**
                ข้อความ: ถูกกว่าในห้างเยอะเลยครับ ภาพชัด สินค้าใหม่ พนักงานบริการดีมาก สั่งสินค้ากับลาซาด้าไม่เคยผิดหวังเลยครับ
                ผลลัพธ์ที่ต้องการ:
                Topic: คุณภาพสินค้าและการบริการ
                Intent: ชื่นชมคุณภาพสินค้าและบริการของพนักงาน
                Sentiment: Positive

            **ตัวอย่างที่ 2**
                ข้อความ: เสียใจความรู้สึกมากกระเป๋าบางมากไม่ตรงกะแบบสินค้าที่ลงการแพ็คของส่งก็แย่เอาถุงดำที่ใส่ขยะแถมสกปรกมากทำไมไม่ตรวจสอบก่อนส่งถึงมือลูกค้าเราไปซื้อของคุณนะไม่ได้ไปขอฟรีๆปรับปรุงด่วน!!!!
                ผลลัพธ์ที่ต้องการ:
                Topic: คุณภาพของกระเป๋าและการแพ็คสินค้า
                Intent: แสดงความไม่พอใจและขอให้ตรวจสอบสินค้าและการแพ็คสินค้า
                Sentiment: Negative

            **ตัวอย่างที่ 3**
                ข้อความ: ส่งของไวมาก แต่ราคาขึ้นลงบ่อยมา ต้องเข้ามาเช็คราคาบ่อยๆ ว่าวันไหนจะราคาถูก แต่คุ้มแน่นอนค่ะ เลือกซื้ออันนี้ไม่ผิดหวังค่ะ
                ผลลัพธ์ที่ต้องการ:
                Topic: การส่งสินค้าและการเปลี่ยนแปลงราคา
                Intent: แสดงความพึงพอใจในบริการส่งสินค้าแต่แสดงความกังวลเรื่องการเปลี่ยนแปลงราคาสินค้า
                Sentiment: Neutral

            **ตัวอย่างที่ 4**
                ข้อความ: ไม่เป็นไปตามที่โฆษณา ส่งสินค้าไม่ตรงตามกำหนด เมื่อสินค้ามีปัญหาไม่รับผิดชอบใด
                ผลลัพธ์ที่ต้องการ:
                Topic: การโฆษณาสินค้า การจัดส่งสินค้า และการบริการหลังการขาย  
                Intent: การร้องเรียนเกี่ยวกับสินค้าไม่สามารถใช้งานได้ตามที่โฆษณา การจัดส่งล่าช้า และต้องการให้บริษัทแสดงความรับผิดชอบหรือชดเชยความเสียหาย  
                Sentiment: Negative

            **ตัวอย่างที่ 5**
                ข้อความ: มันผิดพลาดอะไรหรือลงรูปเพื่อหลอกให้คนสั่งซื้ออธิบายหน่อย
                ผลลัพธ์ที่ต้องการ:
                Topic: การโฆษณาสินค้า
                intent: การร้องเรียนเกี่ยวกับสินค้าไม่สามารถใช้งานได้ตามที่โฆษณาและเรียกร้องคำชี้แจงจากผู้ขาย 
                Sentiment: Negative
                
            **ตัวอย่างที่ 6**
                ข้อความ: โอเคมาก เป็นอย่างที่คาดหวังไว้ เยี่ยม
                ผลลัพธ์ที่ต้องการ:
                Topic: คุณภาพของสินค้า
                Intent: แสดงความพึงพอใจในคุณภาพของสินค้า
                Sentiment: Positive
                
            ### ตัวอย่าง Topic ที่ถูกต้อง
            - คุณภาพสินค้า
            - การจัดส่งสินค้า
            - การบริการลูกค้า

            ### ตัวอย่าง Topic ที่ผิด (โปรดหลีกเลี่ยงการใช้คำเหล่านี้)
            - ความมั่นใจ
            - ไม่มั่นใจในสินค้า
            - ความรู้สึกต่อสินค้า
            - ความเชื่อมั่นต่อสินค้า
            - ความเชื่อมั่นในร้านค้า
            
            ### ตัวอย่าง Intent ที่ถูกต้อง
            - แสดงความไม่พอใจเกี่ยวกับสินค้าและต้องการให้ปรับปรุง
            - ร้องเรียนเกี่ยวกับคุณภาพสินค้าและขอให้ตรวจสอบ
            - แจ้งปัญหาและขอให้ร้านค้ารับผิดชอบ

            ### ตัวอย่าง Intent ที่ผิด (โปรดหลีกเลี่ยงการใช้คำเหล่านี้)
            - ไม่เชื่อถือในสินค้า
            - ไม่มั่นใจในสินค้า
            - รู้สึกผิดหวังกับร้านค้า
            - ความสวยงามของสินค้า
            - ไม่มั่นใจในสินค้า

            """
         },
        {"role": "user",
            "content": text_to_analyze
        }
    ]

    # เรียกใช้ LLM API
    payload = {"model": "Qwen/Qwen2-VL-72B-Instruct-AWQ", "messages": messages, "max_tokens": 500}

    try:
        response = requests.post(MAI_LLM_url, json=payload, headers=headers, timeout=60)

        if response.status_code == 200:
            try:
                result = response.json()
                if "choices" in result and result["choices"]:
                    output_text = result["choices"][0].get("message", {}).get("content", "")
                    return output_text
                else:
                    return("LLM ไม่ได้ส่งคำตอบกลับมา")
            except Exception as e:
                return({"error": f"JSON Parsing Error: {str(e)}"})
        else:
            return(f"เกิดข้อผิดพลาดในการเรียก API: {response.status_code}, {response.text}")
    except Exception as e:
        return({"error": f"เกิดข้อผิดพลาด: {str(e)}"})
    
def parse_llm_output(output_text):
    # พยายามหา JSON block ในข้อความ
    match = re.search(r'\{[\s\S]*\}', output_text)
    if match:
        try:
            return json.loads(match.group())
        except Exception:
            pass
    # ถ้าไม่ใช่ JSON จริง ให้แปลงแบบง่ายๆ
    result = {}
    for key in ["Topic", "Intent", "Sentiment"]:
        m = re.search(rf'{key}\s*:\s*["“]?(.*?)["”]?(?:\n|$)', output_text, re.IGNORECASE)
        if m:
            result[key] = m.group(1).strip()
    return result if result else {"raw": output_text}
    
 # สร้าง API Endpoint
@app.route('/analyze_sentiment', methods=['POST'])
def analyze_sentiment_api():
    data = request.get_json()
    text_to_analyze = data.get('text', '')
    if not text_to_analyze:
        return Response(json.dumps({"error": "Missing text file"}), status=400, mimetype='application/json')
    result = analyze_sentiment_llm(text_to_analyze)
    result_last = parse_llm_output(result)
    return Response(json.dumps({"results": result_last}, ensure_ascii=False), mimetype='application/json')
       
if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0', port=8000, use_reloader=False)